name: Continuous Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - lib/**
      - src/**
      - test/**
      - state-machine.asl.yml
      - template.yml

concurrency:
  group: ${{ github.workflow }}

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  build-sam:
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
      - uses: aws-actions/setup-sam@v1
      - run: sam build --parallel
      - run: zip -rq aws-sam.zip ./.aws-sam/*
      - uses: actions/upload-artifact@v3
        with:
          name: sam-build
          path: aws-sam.zip
          retention-days: 30
  build-docker:
    needs: [lint]
    uses: ./.github/workflows/docker-build.yml
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        account-id:
          - "561178107736"
        region:
          - us-east-1
          - us-west-2
    with:
      account-id: ${{ matrix.account-id }}
      region: ${{ matrix.region }}

  staging-deploy:
    needs: [build-sam, build-docker]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/sam-deploy.yml
    strategy:
      matrix:
        account-id:
          - "561178107736"
        region:
          - us-east-1
          - us-west-2
    with:
      account-id: ${{ matrix.account-id }}
      region: ${{ matrix.region }}

  acceptance-test:
    needs: [staging-deploy]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/acceptance-test.yml
    strategy:
      matrix:
        account-id:
          - "561178107736"
        region:
          - us-east-1
          - us-west-2
        test-bucket:
          - prx-porter-sandbox
        stack-name:
          - porter-staging
    with:
      account-id: ${{ matrix.account-id }}
      region: ${{ matrix.region }}
      test-bucket: ${{ matrix.test-bucket }}
      stack-name: ${{ matrix.stack-name }}

  production-deploy:
    needs: [acceptance-test]
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/sam-deploy.yml
    strategy:
      matrix:
        account-id:
          - "561178107736"
        region:
          - us-east-1
          - us-west-2
    with:
      account-id: ${{ matrix.account-id }}
      region: ${{ matrix.region }}
